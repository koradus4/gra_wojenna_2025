# STRUKTURA PROJEKTU KAMPANIA 1939

## üìå STAN BIE≈ªƒÑCY (29 sierpnia 2025) ‚Äì WERSJA 3.3 ‚Äì POSTƒòP AI I OBSERWOWALNO≈öƒÜ

Aktualizacja koncentruje siƒô na: rozszerzeniu log√≥w (ekonomia + ruch), pakiecie 6 usprawnie≈Ñ AI Commander, trybie u≈õpienia rozkaz√≥w strategicznych (izolacja ekonomii), poprawkach launchera i diagnozie przyczyn szybkiego za≈Çamania si≈Ç.

Najwa≈ºniejsze zmiany od 3.1 ‚Üí 3.3:
1. AI Commander: progresywny ruch, oportunistyczne capture, limity garnizon√≥w + stub rotacji, pre‚Äëcapture phase, bonusy dla od≈ÇƒÖczonych KP, rozszerzone CSV.
2. AI General: rozszerzone kolumny log√≥w (allocate_budget, purchase_budget, low_fuel_ratio, orders_issued, econ_after) + pojedyncze logowanie ko≈Ñca tury.
3. Flaga `GENERATE_ORDERS = False` (tryb SLEEP) ‚Äì testowanie bez niestabilnych makro‚Äërozkaz√≥w.
4. Launcher: czyszczenie log√≥w (Ctrl+Shift+L), wiƒôksze okno, komunikaty diagnostyczne.
5. Analiza attrition: spadek own_units bez pakietu ratunkowego ‚Üí plan Emergency Mode.
6. Wdro≈ºone ≈ºetony kopiowane do `assets/tokens/aktualne/` (parytet z graczem) ‚Äì brak jeszcze czyszczenia tego katalogu.

Status: mo≈ºna graƒá przeciw AI (taktyczny op√≥r umiarkowany); d≈Çu≈ºsza kampania ko≈Ñczy siƒô pora≈ºkƒÖ AI z powodu braku walki selektywnej i trybu ratunkowego.

---

## üìÅ STRUKTURA KODU (REALNA + PLANOWANA)

```
projekt/
‚îú‚îÄ‚îÄ main.py                      # G≈Ç√≥wny launcher gry (GUI, konfiguracja)
‚îú‚îÄ‚îÄ main_alternative.py          # Szybki start (bez ekranu konfiguracji)
‚îú‚îÄ‚îÄ requirements.txt             # Zale≈ºno≈õci
‚îú‚îÄ‚îÄ STRUKTURA_PROJEKTU.md        # Ten plik
‚îú‚îÄ‚îÄ accessibility/               # Rozszerzenia dostƒôpno≈õci (szkielety)
‚îú‚îÄ‚îÄ backup/                      # System kopii zapasowych
‚îú‚îÄ‚îÄ core/                        # Logika ‚Äûbiznesowa‚Äù tur, ekonomii itd.
‚îú‚îÄ‚îÄ data/                        # Dane map / konfiguracja
‚îú‚îÄ‚îÄ docs/                        # Dokumentacja dodatkowa
‚îú‚îÄ‚îÄ edytory/                     # Edytory map / ≈ºeton√≥w
‚îú‚îÄ‚îÄ engine/                      # Silnik gry (board, token, akcje, widoczno≈õƒá)
‚îú‚îÄ‚îÄ gui/                         # Panele interfejsu u≈ºytkownika
‚îú‚îÄ‚îÄ saves/                       # Zapisy stanu
‚îú‚îÄ‚îÄ scripts/                     # Skrypty porzƒÖdkowe / automatyzacja
‚îú‚îÄ‚îÄ tests/                       # Testy (uporzƒÖdkowane w podkatalogi)
‚îÇ   ‚îú‚îÄ‚îÄ core/                   # Testy logiki biznesowej
‚îÇ   ‚îú‚îÄ‚îÄ engine/                 # Testy silnika gry
‚îÇ   ‚îú‚îÄ‚îÄ gui/                    # Testy interfejsu
‚îÇ   ‚îú‚îÄ‚îÄ integration/            # Testy integracyjne
‚îÇ   ‚îî‚îÄ‚îÄ testy_dla_podrecznika/  # Testy dokumentacyjne
‚îú‚îÄ‚îÄ tools/                       # Narzƒôdzia diagnostyczne
‚îú‚îÄ‚îÄ tools/                       # Narzƒôdzia diagnostyczne
‚îú‚îÄ‚îÄ utils/                       # Pomocnicze modu≈Çy
‚îî‚îÄ‚îÄ ai/                          # Wstƒôpny modu≈Ç sztucznej inteligencji (Faza 1 czƒô≈õciowa)
```

### Katalog `ai/` (stan bie≈ºƒÖcy + planowane rozszerzenia)
```
ai/
‚îú‚îÄ‚îÄ __init__.py
 ‚îú‚îÄ‚îÄ ai_general.py        # (ZAIMPLEMENTOWANE) Genera≈Ç AI: analiza ekonomii, alokacja punkt√≥w, logi
 ‚îú‚îÄ‚îÄ state_adapter.py     # (PLAN) Ekstrakcja stanu z GameEngine ‚Üí struktury AI
 ‚îú‚îÄ‚îÄ evaluator.py         # (PLAN) Heurystyki i funkcje oceny (scoring)
 ‚îú‚îÄ‚îÄ tactical_agent.py    # (PLAN) Decyzje ruchu i walki (dow√≥dcy)
 ‚îú‚îÄ‚îÄ strategic_agent.py   # (PLAN) Priorytety key points, zakupy, plan tury
 ‚îú‚îÄ‚îÄ base_agent.py        # (PLAN) Klasy bazowe / interfejsy
 ‚îú‚îÄ‚îÄ decision_queue.py    # (PLAN) Kolejkowanie i filtrowanie akcji
 ‚îú‚îÄ‚îÄ memory/              # (PLAN) Logi i dane adaptacyjne
 ‚îî‚îÄ‚îÄ README.md            # (PLAN) Dokumentacja modu≈Çu AI
```

### Tabela postƒôpu faz AI (stan na 29.08.2025)

| Faza | Status | Pokrycie | Notatki |
|------|--------|----------|---------|
| 0 Dokumentacja kontraktu | ZAKO≈ÉCZONA | 100% | API zidentyfikowane w wersji 3.0 |
| 1 Szkielet modu≈Çu | ZAKO≈ÉCZONA | 100% | AI Commander + AI General implementowane |
| 2 Adapter stanu | CZƒò≈öCIOWO | ~60% | Podstawowa analiza stanu, brak pe≈Çnego JSON API |
| 3 Ruch taktyczny | CZƒò≈öCIOWO | ~55% | Ruch, progresywny movement, garrison limit, opportunistic capture |
| 4 Walka selektywna | NIE ROZPOCZƒòTO | 0% | Brak pe≈Çnej integracji CombatAction (tylko sporadyczne ataki) |
| 5 Strategia key points | CZƒò≈öCIOWO | ~45% | Capture opportunistyczne + bonusy, brak trwa≈Çego hold/rotation |
| 6 Ekonomia / zakupy | CZƒò≈öCIOWO | ~75% | Zakupy + alokacja, brak Emergency bundle/resupply |
| 7 Poziomy trudno≈õci | CZƒò≈öCIOWO | ~20% | Heurystyki statyczne; brak MCTS/adaptacji |
| 8 Logowanie decyzji | CZƒò≈öCIOWO | ~75% | Rozszerzone CSV (economy + commander), brak skip_reason/casualties |
| 9 Adaptacja | NIE ROZPOCZƒòTO | 0% | Brak pamiƒôci / uczenia maszynowego |

### Obecna funkcjonalno≈õƒá AI (3.2 - ZAKTUALIZOWANA)

**AI GENERAL (KOMPLETNY POZIOM STRATEGICZNY):**
* ‚úÖ Pe≈Çny parytet z human genera≈Çem - VP, Key Points, faza gry
* ‚úÖ 5 strategii adaptacyjnych (ROZW√ìJ/KRYZYS_PALIWA/DESPERACJA/OCHRONA/EKSPANSJA)
* ‚úÖ System bud≈ºetu 20-40-40 z elastycznym podzia≈Çem
* ‚úÖ Analiza per dow√≥dca (paliwo, combat value, typy jednostek)
* ‚úÖ EconAction.COMBO - kombinacja alokacji + zakup√≥w
* ‚úÖ Kompletne logowanie ekonomii, Key Points, strategii
* ‚ùå **BRAK: MCTS algorithm, machine learning, poziomy trudno≈õci**

**AI COMMANDER (ROZSZERZONY PODSTAWOWY):**
* ‚úÖ Ruch (full + progresywny) z adaptacjƒÖ MP
* ‚úÖ Oportunistyczne capture + priorytety dla od≈ÇƒÖczonych KP
* ‚úÖ Garrison limit + podstawowy stub rotacji
* ‚úÖ Rozszerzone logi: path_len, path_used, progressive_used, decision_reason
* ‚ùå Brak pe≈Çnych zasad walki (risk gating)
* ‚ùå Brak resupply (pre_resupply placeholder)
* ‚ùå Brak retreat/reposition heurystyk
* ‚ùå Brak skip_reason w logu (diagnoza stagnacji utrudniona)
* ‚ùå Brak pe≈Çnej rotacji garnizon√≥w

### Znane ograniczenia (3.3)

**AI GENERAL:**
* Brak Monte Carlo Tree Search dla trudniejszych poziom√≥w
* Brak machine learning adaptacji miƒôdzy grami  
* Brak opponent modeling
* Sztywne strategie bez dynamicznego dostrajania wag

**AI COMMANDER (KRYTYCZNE LUKI):**
* pre_resupply() placeholder ‚Äì brak wydawania punkt√≥w
* Brak mechanizmu emergency (gwa≈Çtowny spadek own_units)
* Brak risk-based combat (cv_ratio / przewidywane straty)
* Brak skip_reason w logach
* Brak purge martwych alokacji (bud≈ºet mro≈ºony w sektorach 0 units)

---

## üß† ARCHITEKTURA LOGICZNA

| Warstwa | Obecnie | Rola w AI |
|---------|---------|-----------|
| Engine (`engine/`) | TAK | Dostarcza prymitywy: ruch, walka, widoczno≈õƒá, stan |
| Core (`core/`) | TAK | Tury, ekonomia (key points), warunki zwyciƒôstwa |
| GUI (`gui/`) | TAK | Interakcja cz≈Çowieka ‚Äì dla AI nieu≈ºywana (AI dzia≈Ça programowo) |
| Edytory | TAK | Generowanie/scenariusze testowe |
| AI (`ai/`) | CZƒò≈öCIOWO | Ekonomia (alokacja), analiza stanu ‚Äì brak ruchu i walk |

---

## üîå PUBLICZNY KONTRAKT DLA AI

### 1. Silnik (`GameEngine` w `engine/engine.py`)
Kluczowe atrybuty/metody dostƒôpne bez zmian kodu:
- `engine.tokens` ‚Äì lista obiekt√≥w `Token`
- `engine.board` ‚Äì obiekt planszy
- `engine.turn`, `engine.current_player`
- `engine.execute_action(action, player)` ‚Üí `(success, message)` / `ActionResult`
- `engine.end_turn()` / `engine.next_turn()`
- `engine.process_key_points(players)` ‚Äì przydzia≈Ç ekonomii
- `engine.update_all_players_visibility(players)` ‚Äì aktualizacja FOW
- `engine.key_points_state` ‚Äì s≈Çownik key points

### 2. Token (`engine/token.py`)
Pola: `id, owner, q, r, stats{move, combat_value, defense_value, attack{value, range}, sight, price, nation}`
Dynamiczne: `currentMovePoints, currentFuel, combat_value, movement_mode`
Metody: `apply_movement_mode(reset_mp=True)`, `get_movement_points()`, `can_move_reason()`

### 3. Plansza (`engine/board.py`)
- `find_path(start, goal, max_mp, max_fuel, visible_tokens=None, fallback_to_closest=False)`
- `hex_distance(a, b)`
- `get_tile(q, r)` ‚Üí `Tile(move_mod, defense_mod, type, value, spawn_nation)`
- `is_occupied(q, r)` / `neighbors(q, r)`

### 4. Akcje (`engine/action_refactored_clean.py`)
- `MoveAction(token_id, dest_q, dest_r)`
- `CombatAction(attacker_id, defender_id)`
- `ActionResult(success, message, data)`

### 5. Widoczno≈õƒá
- Po wywo≈Çaniu `update_all_players_visibility`: `player.visible_hexes`, `player.visible_tokens`
- Genera≈Ç: pe≈Çna widoczno≈õƒá w≈Çasnych + wrogowie odkryci przez dow√≥dc√≥w

### 6. Key Points
- Format: `key_points_state['q,r'] = {initial_value, current_value, type}`
- Pozosta≈Ça ‚Äû≈ºywotno≈õƒá‚Äù = `ceil(current_value / (0.1 * initial_value))` tur

### 7. (Do dodania) API zakup√≥w ‚Äì proponowany kontrakt
```
engine.purchase_unit(player, blueprint_id, spawn_hex) -> (success: bool, msg: str, token_id: Optional[str])
```
Walidacja: dostƒôpne punkty ekonomiczne, poprawny spawn (`tile.spawn_nation == player.nation`), unikalno≈õƒá ID.

---

## üß© UPROSZCZONY WIDOK STANU DLA AI (PROPOZYCJA)
```jsonc
{
  "turn": 7,
  "player": {"id": 2, "role": "dow√≥dca", "nation": "Polska"},
  "economy": {"points": 40},
  "key_points": [ {"q":3,"r":-1,"type":"city","current":70,"ours":true} ],
  "self_tokens": [ {"id":"P_INF_1","q":3,"r":0,"cv":5,"mp":5,"fuel":10,"atk":4,"rng":2,"def":3} ],
  "enemy_visible": [ {"id":"N_TANK_2","q":5,"r":0,"cv":8,"rng":1} ],
  "map": {"cols": X, "rows": Y}
}
```

---

## üßÆ HEURYSTYKA STARTOWA (ITERACJA 1)
Formu≈Ça punktacji heksa docelowego:  
`SCORE = (V_strategiczna + V_ofensywna - R_ryzyko) / (1 + koszt_ruchu)`

Sk≈Çadniki:
- `V_strategiczna`: +wsp√≥≈Çczynnik * (typ key point * pozosta≈Çe tury ≈ºycia) + bonus za `defense_mod`
- `V_ofensywna`: mo≈ºliwo≈õƒá ataku na jednostkƒô o niskim `combat_value` / wysokiej cenie
- `R_ryzyko`: liczba wrogich kontratak√≥w * przewidywane straty
- `koszt_ruchu`: suma koszt√≥w MP trasy (A*)

Progi decyzji (konfigurowalne):
- Nie atakuj je≈õli przewidywane straty > 60% w≈Çasnego `combat_value`
- Priorytet key pointu je≈õli wyczerpie siƒô w ‚â§ 3 turach
- Unikaj p√≥l w zasiƒôgu ‚â• 3 wrogich jednostek o zasiƒôgu ataku

---

## üîÑ PLAN WDRO≈ªENIA AI (FAZY)

| Faza | Zakres | Artefakty | Kryterium sukcesu |
|------|--------|-----------|-------------------|
| 0 | Dokumentacja kontraktu | Ten plik | API kompletne bez refactoru silnika |
| 1 | Szkielet modu≈Çu | `ai/` + klasy bazowe | Import dzia≈Ça, test pusty przechodzi |
| 2 | Adapter stanu | `state_adapter.py` | Zwraca sp√≥jny JSON dla dow√≥dcy i genera≈Ça |
| 3 | Ruch taktyczny | `tactical_agent.py` | Jednostki przemieszczajƒÖ siƒô legalnie do celu |
| 4 | Walka selektywna | Ewaluator | AI eliminuje os≈Çabione jednostki bez suicyd√≥w |
| 5 | Strategia key points | `strategic_agent.py` | AI kieruje ‚â•50% ruch√≥w ku kluczowym celom |
| 6 | Ekonomia / zakupy | purchase API | Nowe jednostki poprawnie spawnujƒÖ siƒô |
| 7 | Poziomy trudno≈õci | konfiguracja wag | R√≥≈ºne style zachowa≈Ñ (defensywne/agresywne) |
| 8 | Logowanie decyzji | `memory/` | Powtarzalno≈õƒá przy identycznym seed |
| 9 | Adaptacja (opcjonalnie) | analityka wag | Poprawa wyniku VP w serii test√≥w |

---

## üß™ REKOMENDOWANE TESTY (NOWE DLA AI)
- `test_ai_state_adapter.py` ‚Äì poprawno≈õƒá formatu i filtrowanie widoczno≈õci
- `test_ai_path_selection.py` ‚Äì wyb√≥r najkorzystniejszej ≈õcie≈ºki (mniejszy koszt)
- `test_ai_target_selection.py` ‚Äì selekcja celu o najlepszym stosunku (warto≈õƒá / ryzyko)
- `test_ai_key_point_focus.py` ‚Äì ruch w stronƒô krytycznego key pointu
- `test_ai_purchase_logic.py` ‚Äì brak nadwy≈ºek ekonomii i validacja spawn√≥w
- `test_ai_determinism.py` ‚Äì identyczne decyzje dla ustalonego seeda

---

## üìä STATYSTYKI (AKTUALNE ‚Äì WERSJA 3.1)
- Edytor ≈ºeton√≥w: 1427 linii
- Edytor map: 1088 linii
- Silnik (engine + akcje + board + token): ~850+ linii
- GUI: ~1000+ linii
- Modu≈Ç AI: wstƒôpny (2 pliki: `__init__.py`, `ai_general.py`) ‚Äì kod alokatora + logika analizy

Funkcjonalno≈õci potwierdzone: ruch, walka, pathfinding, widoczno≈õƒá warstwowa, key points z ekonomiƒÖ, zapis stanu, refaktoryzowane akcje.

---

## üèÜ SYSTEM KEY POINTS ‚Äì SKR√ìT TECHNICZNY
- Struktura w `engine.key_points_state`
- Przydzia≈Ç ekonomii: `give = max(1, int(0.1 * initial_value))` (nie wiƒôkszy ni≈º `current_value`)
- Po wyzerowaniu usuniƒôcie z mapy + zapis aktualizacji

Sugestia dla AI: planowanie kolejki przejƒôƒá wed≈Çug (pozosta≈Çe_tury * typ_wagi) ‚Äì (dystans MP).

---

## üó∫Ô∏è WIDOCZNO≈öƒÜ I FOG OF WAR (ISTOTNE DLA AI)
- Dow√≥dca: widzi tylko heksy w zasiƒôgu swoich ≈ºeton√≥w (+ tymczasowe)
- Genera≈Ç: agregacja widoczno≈õci dow√≥dc√≥w + pe≈Çna wiedza o w≈Çasnych jednostkach
- Aktualizacja: `engine.update_all_players_visibility(players)` po ruchach / na starcie tury

AI musi dzia≈Çaƒá w ramach tej samej informacji (brak ‚Äûcheat vision‚Äù).

---

## üîê ZASADY FAIR PLAY DLA AI
- Brak podejmowania akcji na podstawie niewidocznych wrog√≥w
- Brak modyfikacji punkt√≥w ruchu / paliwa poza systemem
- Zakupy tylko przez publiczne API zakup√≥w
- Decyzje deterministyczne przy ustalonym seed (testowalno≈õƒá)

---

## üß≠ NASTƒòPNE KROKI (PRIORYTETY TECHNICZNE ‚Äì AKTUALNE 29.08.2025)

### **IMMEDIATE PRIORITIES ‚Äì AI COMMANDER (NOWE)**
1. Emergency Mode (own_units ‚â§ 8) ‚Äì wymusza zakup pakietu: 2x P + 1x Z (+1x AL je≈õli bud≈ºet pozwala).
2. Purge martwych alokacji ‚Äì reset wag sektora po 2 turach z total_units==0.
3. Resupply podstawowy ‚Äì paliwo <30% ‚Üí combat <50% (priorytet mobilne + supply chain).
4. Skip reason w logu (NO_PATH / ZERO_MP / GARRISON_HOLD / LOW_FUEL / BLOCKED).
5. Minimalny filtr walki: atak tylko je≈õli cv_ratio ‚â• 1.3.

### **MEDIUM TERM ‚Äì AI GENERAL**
6. MCTS po stabilizacji taktyki ‚Äì lookahead 3‚Äì5 tur.
7. Poziomy trudno≈õci ‚Äì parametryzacja wag (agresja, supply bias, cv_threshold).

### **LONG TERM ‚Äì ADVANCED AI / KOORDYNACJA**
8. Machine Learning (pamiƒôƒá serii) ‚Äì meta‚Äëstatystyki skuteczno≈õci.
9. Feedback loop General‚ÜîCommander ‚Äì adaptacja alokacji wg efektywno≈õci ruch√≥w.
10. Commander specialization ‚Äì profile agresywny / defensywny / mobilny.

## üóíÔ∏è CHANGELOG
**3.3 (29.08.2025)**
* Pakiet 6 usprawnie≈Ñ AI Commander (movement/capture/garrison/logi)
* Rozszerzone logi ekonomii (allocate/purchase budgets, low_fuel_ratio, orders_issued)
* Tryb SLEEP strategicznych rozkaz√≥w (generowanie = False)
* Launcher: czyszczenie log√≥w, skr√≥t, wiƒôksze okno
* Diagnoza attrition ‚Üí plan Emergency Mode & purge
* Wykryty brak czyszczenia `assets/tokens/aktualne/`

**3.2 (24.08.2025)** ‚Äì analiza stanu, logi rozszerzone, identyfikacja brak√≥w

**3.0 (15.08.2025)** ‚Äì kontrakt AI, szkic faz

## ‚ö° SZYBKI START (JUTRO ‚Äì 5 MIN)
1. Uruchom launcher ‚Üí Start Gry (potwierd≈∫ auto‚Äëczyszczenie). 
2. Sprawd≈∫ `ai/ai_general.py` czy `GENERATE_ORDERS` ma oczekiwanƒÖ warto≈õƒá.
3. W≈ÇƒÖcz AI dla Niemiec (genera≈Ç + dow√≥dcy), zagraj 5 tur.
4. Zapisz turƒô spadku own_units ‚â§ 10 (log `ai_actions_*.csv`).
5. Notuj gdzie brak ruchu ‚Äì przyda siƒô do skip_reason.

## üß™ METRYKI DO DODANIA
| Metryka | Cel | Wykorzystanie |
|---------|-----|---------------|
| casualties_turn | tracking attrition | wyzwalacz Emergency Mode |
| new_units_turn | tempo odtwarzania | ocena skuteczno≈õci pakiet√≥w |
| effective_move_rate | aktywno≈õƒá taktyczna | wykrycie stagnacji |
| skip_reason | diagn. stagnacji | tuning heurystyk ruchu |
| econ_efficiency | wydatkowanie bud≈ºetu | ocena alokacji Genera≈Ça |

## üßº PLAN ROZSZERZENIA CZYSZCZENIA
Aktualnie: quick_clean() usuwa tylko `nowe_dla_*`; full_clean() dodatkowo logi. NIE usuwa `assets/tokens/aktualne/` ani `saves/after_deployment.json`.
Plan: dodaƒá `clean_deployed_tokens()` + wywo≈Çaƒá w full_clean (opcjonalna flaga zachowania).

## üîç DIAGNOSTYKA PO SESJI
| Pytanie | Gdzie patrzeƒá | Oczekiwane |
|---------|---------------|------------|
| Czy attrition stabilne? | ai_actions own_units | Brak gwa≈Çtownych spadk√≥w <50%/3 tury |
| Czy bud≈ºet nie stoi? | econ_after vs econ_before | Spadek >50% przy COMBO |
| Czy ruch aktywny? | turn_summary moved_units | ‚â•70% wczesnych tur |
| (po wdro≈ºeniu) skip_reason pe≈Çny? | actions CSV | <10% pustych |

---

## üìö META
Dokument przygotowuje grunt pod implementacjƒô gracza komputerowego bez refaktoryzacji istniejƒÖcych modu≈Ç√≥w. Zmiany w silniku ograniczyƒá do dodania (je≈õli brak) jednolitego API zakup√≥w.

Wersja: 3.3 (29 sierpnia 2025)
Status: Czƒô≈õciowa implementacja (Genera≈Ç ekonomia + taktyczne usprawnienia)
Autor aktualizacji: automatyczny asystent + analiza log√≥w

---

*Koniec dokumentu.*
